<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#667eea">
    <title>üç¨ Sweet Match</title>
    <link rel="manifest" href="data:application/json,{
        &quot;name&quot;: &quot;Sweet Match&quot;,
        &quot;short_name&quot;: &quot;SweetMatch&quot;,
        &quot;start_url&quot;: &quot;.&quot;,
        &quot;display&quot;: &quot;standalone&quot;,
        &quot;background_color&quot;: &quot;%23667eea&quot;,
        &quot;theme_color&quot;: &quot;%23667eea&quot;,
        &quot;orientation&quot;: &quot;portrait&quot;
    }">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üç¨</text></svg>">
</head>
<body>
    <div id="app"></div>
    <script>
// ==================== CONFIGURATION ====================
const CONFIG = {
    GRID_SIZE: 8,
    CANDY_TYPES: ['üç¨', 'üç≠', 'üç´', 'üç©', 'üßÅ', 'üç™'],
    CANDY_COLORS: ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#ffeaa7', '#dfe6e9'],
    LEVELS: 50,
    MOVES_BASE: 20,
    SCORE_MULTIPLIER: 10,
    COMBO_MULTIPLIER: 1.5
};

const AVATARS = [
    "https://raw.githubusercontent.com/Tarikul-Islam-Anik/Animated-Fluent-Emojis/master/Emojis/People/Boy.png",
    "https://raw.githubusercontent.com/Tarikul-Islam-Anik/Animated-Fluent-Emojis/master/Emojis/People/Girl.png",
    "https://raw.githubusercontent.com/Tarikul-Islam-Anik/Animated-Fluent-Emojis/master/Emojis/Smilies/Crying%20Cat.png",
    "https://raw.githubusercontent.com/Tarikul-Islam-Anik/Animated-Fluent-Emojis/master/Emojis/Smilies/Enraged%20Face.png",
    "https://raw.githubusercontent.com/Tarikul-Islam-Anik/Animated-Fluent-Emojis/master/Emojis/People/Detective.png",
    "https://raw.githubusercontent.com/Tarikul-Islam-Anik/Animated-Fluent-Emojis/master/Emojis/People/Man%20Vampire.png",
    "https://raw.githubusercontent.com/Tarikul-Islam-Anik/Animated-Fluent-Emojis/master/Emojis/People/Man%20Supervillain.png",
    "https://raw.githubusercontent.com/Tarikul-Islam-Anik/Animated-Fluent-Emojis/master/Emojis/People/Person%20Juggling.png",
    "https://raw.githubusercontent.com/Tarikul-Islam-Anik/Animated-Fluent-Emojis/master/Emojis/Animals/Butterfly.png",
    "https://raw.githubusercontent.com/Tarikul-Islam-Anik/Animated-Fluent-Emojis/master/Emojis/Animals/Dog%20Face.png",
    "https://raw.githubusercontent.com/Tarikul-Islam-Anik/Animated-Fluent-Emojis/master/Emojis/Animals/Frog.png",
    "https://raw.githubusercontent.com/Tarikul-Islam-Anik/Animated-Fluent-Emojis/master/Emojis/Animals/Fox.png",
    "https://raw.githubusercontent.com/Tarikul-Islam-Anik/Animated-Fluent-Emojis/master/Emojis/Animals/Monkey%20Face.png",
    "https://raw.githubusercontent.com/Tarikul-Islam-Anik/Animated-Fluent-Emojis/master/Emojis/Animals/Orangutan.png",
    "https://raw.githubusercontent.com/Tarikul-Islam-Anik/Animated-Fluent-Emojis/master/Emojis/Animals/Panda.png",
    "https://raw.githubusercontent.com/Tarikul-Islam-Anik/Animated-Fluent-Emojis/master/Emojis/Animals/Raccoon.png",
    "https://raw.githubusercontent.com/Tarikul-Islam-Anik/Animated-Fluent-Emojis/master/Emojis/Animals/Snake.png",
    "https://raw.githubusercontent.com/Tarikul-Islam-Anik/Animated-Fluent-Emojis/master/Emojis/Animals/Tiger%20Face.png"
];

const ACHIEVEMENTS = [
    { id: 'first_match', name: 'üåü Premier Match', desc: 'R√©alise ton premier match-3', condition: (p) => p.totalMatches >= 1 },
    { id: 'combo_master', name: 'üî• Ma√Ætre Combo', desc: 'Fais un combo de 5+', condition: (p) => p.maxCombo >= 5 },
    { id: 'level_5', name: 'üéØ Niveau 5', desc: 'Atteins le niveau 5', condition: (p) => p.currentLevel >= 5 },
    { id: 'level_10', name: 'üèÜ Niveau 10', desc: 'Atteins le niveau 10', condition: (p) => p.currentLevel >= 10 },
    { id: 'score_1000', name: 'üíé 1000 Points', desc: 'Score total de 1000', condition: (p) => p.totalScore >= 1000 },
    { id: 'score_10000', name: 'üëë 10000 Points', desc: 'Score total de 10000', condition: (p) => p.totalScore >= 10000 },
    { id: 'daily_3', name: 'üìÖ Fid√®le', desc: '3 jours cons√©cutifs', condition: (p) => p.dailyStreak >= 3 },
    { id: 'daily_7', name: 'üóìÔ∏è Assidu', desc: '7 jours cons√©cutifs', condition: (p) => p.dailyStreak >= 7 }
];

// ==================== STYLES ====================
const styles = document.createElement('style');
styles.textContent = `
:root {
    --primary: #667eea;
    --primary-dark: #5a67d8;
    --secondary: #f093fb;
    --accent: #ffd93d;
    --success: #6bcb77;
    --danger: #ff6b6b;
    --bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --card-bg: rgba(255,255,255,0.95);
    --text: #2d3436;
    --text-light: #636e72;
    --shadow: 0 10px 40px rgba(0,0,0,0.2);
    --radius: 20px;
    --safe-top: env(safe-area-inset-top, 20px);
    --safe-bottom: env(safe-area-inset-bottom, 20px);
}

.dark-mode {
    --card-bg: rgba(45,52,54,0.95);
    --text: #dfe6e9;
    --text-light: #b2bec3;
    --bg: linear-gradient(135deg, #2d3436 0%, #000000 100%);
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    -webkit-tap-highlight-color: transparent;
    -webkit-touch-callout: none;
    -webkit-user-select: none;
    user-select: none;
}

html, body {
    height: 100%;
    overflow: hidden;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
    background: var(--bg);
    color: var(--text);
    touch-action: manipulation;
}

#app {
    height: 100%;
    display: flex;
    flex-direction: column;
    padding-top: var(--safe-top);
    padding-bottom: var(--safe-bottom);
}

/* ===== SCREENS ===== */
.screen {
    display: none;
    flex-direction: column;
    height: 100%;
    padding: 15px;
    animation: fadeIn 0.3s ease;
}

.screen.active {
    display: flex;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* ===== HEADER ===== */
.header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 0;
    margin-bottom: 15px;
}

.header h1 {
    font-size: 1.5rem;
    color: white;
    text-shadow: 0 2px 10px rgba(0,0,0,0.3);
}

.header-btn {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    background: var(--card-bg);
    border: none;
    font-size: 1.3rem;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: var(--shadow);
    transition: transform 0.2s;
}

.header-btn:active {
    transform: scale(0.95);
}

/* ===== CARDS ===== */
.card {
    background: var(--card-bg);
    border-radius: var(--radius);
    padding: 20px;
    margin-bottom: 15px;
    box-shadow: var(--shadow);
}

.card-title {
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 10px;
}

/* ===== BUTTONS ===== */
.btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    padding: 15px 25px;
    border-radius: 15px;
    border: none;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}

.btn:active {
    transform: scale(0.97);
}

.btn-primary {
    background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
    color: white;
}

.btn-success {
    background: linear-gradient(135deg, var(--success) 0%, #4ecdc4 100%);
    color: white;
}

.btn-danger {
    background: linear-gradient(135deg, var(--danger) 0%, #ee5a24 100%);
    color: white;
}

.btn-secondary {
    background: var(--card-bg);
    color: var(--text);
}

.btn-block {
    width: 100%;
}

.btn-sm {
    padding: 10px 20px;
    font-size: 0.9rem;
}

/* ===== PROFILE CARDS ===== */
.profile-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
    flex: 1;
    overflow-y: auto;
    padding-bottom: 20px;
}

.profile-card {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 15px;
    background: var(--card-bg);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    cursor: pointer;
    transition: transform 0.2s;
}

.profile-card:active {
    transform: scale(0.98);
}

.profile-avatar {
    width: 55px;
    height: 55px;
    border-radius: 50%;
    object-fit: cover;
    background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
    padding: 3px;
}

.profile-avatar img {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    background: white;
}

.profile-info {
    flex: 1;
}

.profile-name {
    font-weight: 600;
    font-size: 1.1rem;
}

.profile-stats {
    font-size: 0.85rem;
    color: var(--text-light);
    margin-top: 3px;
}

.profile-badge {
    font-size: 1.5rem;
}

.protected-badge {
    font-size: 0.8rem;
    background: var(--accent);
    padding: 3px 8px;
    border-radius: 10px;
    margin-left: 8px;
}

/* ===== AVATAR GRID ===== */
.avatar-grid {
    display: grid;
    grid-template-columns: repeat(6, 1fr);
    gap: 10px;
    margin: 15px 0;
}

.avatar-option {
    aspect-ratio: 1;
    border-radius: 50%;
    cursor: pointer;
    border: 3px solid transparent;
    transition: all 0.2s;
    overflow: hidden;
    background: #f0f0f0;
}

.avatar-option.selected {
    border-color: var(--primary);
    transform: scale(1.1);
    box-shadow: 0 0 20px rgba(102, 126, 234, 0.5);
}

.avatar-option img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

/* ===== FORM INPUTS ===== */
.input-group {
    margin-bottom: 15px;
}

.input-group label {
    display: block;
    font-weight: 500;
    margin-bottom: 8px;
    font-size: 0.9rem;
}

.input-group input {
    width: 100%;
    padding: 15px;
    border: 2px solid #e0e0e0;
    border-radius: 12px;
    font-size: 1rem;
    transition: border-color 0.2s;
    background: var(--card-bg);
    color: var(--text);
}

.input-group input:focus {
    outline: none;
    border-color: var(--primary);
}

/* ===== PIN INPUT ===== */
.pin-container {
    display: flex;
    gap: 10px;
    justify-content: center;
    margin: 20px 0;
}

.pin-digit {
    width: 55px;
    height: 65px;
    font-size: 1.8rem;
    text-align: center;
    border: 2px solid #e0e0e0;
    border-radius: 12px;
    background: var(--card-bg);
    color: var(--text);
}

.pin-digit:focus {
    outline: none;
    border-color: var(--primary);
}

/* ===== GAME BOARD ===== */
.game-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.game-stats {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
    margin-bottom: 15px;
}

.stat-box {
    background: var(--card-bg);
    border-radius: 15px;
    padding: 12px;
    text-align: center;
    box-shadow: var(--shadow);
}

.stat-value {
    font-size: 1.5rem;
    font-weight: 700;
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.stat-label {
    font-size: 0.75rem;
    color: var(--text-light);
    text-transform: uppercase;
    margin-top: 3px;
}

.game-board {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 10px;
}

.grid {
    display: grid;
    gap: 4px;
    background: rgba(255,255,255,0.1);
    padding: 10px;
    border-radius: 20px;
    box-shadow: inset 0 0 30px rgba(0,0,0,0.2);
}

.cell {
    aspect-ratio: 1;
    background: rgba(255,255,255,0.9);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.8rem;
    cursor: pointer;
    transition: all 0.15s;
    box-shadow: 0 3px 10px rgba(0,0,0,0.1);
}

.cell.selected {
    transform: scale(1.15);
    box-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
    z-index: 10;
}

.cell.matched {
    animation: matchPop 0.4s ease forwards;
}

.cell.falling {
    animation: fall 0.3s ease;
}

.cell.hint {
    animation: hint 1s ease infinite;
}

@keyframes matchPop {
    0% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.4); }
    100% { transform: scale(0); opacity: 0; }
}

@keyframes fall {
    from { transform: translateY(-100%); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

@keyframes hint {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); box-shadow: 0 0 15px var(--accent); }
}

.game-actions {
    display: flex;
    gap: 10px;
    padding: 10px 0;
}

/* ===== LEVEL MAP ===== */
.level-map {
    flex: 1;
    overflow-y: auto;
    padding: 10px;
}

.level-path {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 20px;
    padding: 20px 0;
}

.level-node {
    width: 70px;
    height: 70px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    font-weight: 700;
    color: white;
    box-shadow: var(--shadow);
    cursor: pointer;
    transition: transform 0.2s;
    position: relative;
}

.level-node.completed {
    background: linear-gradient(135deg, var(--success), #4ecdc4);
}

.level-node.current {
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    animation: pulse 2s ease infinite;
}

.level-node.locked {
    background: #95a5a6;
    cursor: not-allowed;
}

.level-node.locked::after {
    content: 'üîí';
    position: absolute;
    font-size: 0.8rem;
}

.level-connector {
    width: 4px;
    height: 30px;
    background: rgba(255,255,255,0.3);
    border-radius: 2px;
}

@keyframes pulse {
    0%, 100% { transform: scale(1); box-shadow: var(--shadow); }
    50% { transform: scale(1.05); box-shadow: 0 0 30px rgba(102, 126, 234, 0.6); }
}

/* ===== LEADERBOARD ===== */
.leaderboard-list {
    max-height: 400px;
    overflow-y: auto;
}

.leaderboard-item {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 12px;
    background: var(--card-bg);
    border-radius: 15px;
    margin-bottom: 10px;
    box-shadow: 0 3px 15px rgba(0,0,0,0.1);
}

.leaderboard-rank {
    width: 35px;
    height: 35px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 1rem;
}

.rank-1 { background: linear-gradient(135deg, #ffd700, #ffed4a); color: #5c4d00; }
.rank-2 { background: linear-gradient(135deg, #c0c0c0, #e8e8e8); color: #4a4a4a; }
.rank-3 { background: linear-gradient(135deg, #cd7f32, #e8a85c); color: #4a3520; }
.rank-other { background: #f0f0f0; color: #666; }

.leaderboard-avatar {
    width: 45px;
    height: 45px;
    border-radius: 50%;
}

.leaderboard-info {
    flex: 1;
}

.leaderboard-name {
    font-weight: 600;
}

.leaderboard-level {
    font-size: 0.8rem;
    color: var(--text-light);
}

.leaderboard-score {
    font-weight: 700;
    font-size: 1.1rem;
    color: var(--primary);
}

.leaderboard-item.current-user {
    border: 2px solid var(--primary);
    background: linear-gradient(135deg, rgba(102,126,234,0.1), rgba(240,147,251,0.1));
}

/* ===== DAILY REWARD ===== */
.daily-reward-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    padding: 20px;
}

.daily-reward-content {
    background: var(--card-bg);
    border-radius: var(--radius);
    padding: 30px;
    text-align: center;
    max-width: 320px;
    animation: bounceIn 0.5s ease;
}

@keyframes bounceIn {
    0% { transform: scale(0.5); opacity: 0; }
    70% { transform: scale(1.1); }
    100% { transform: scale(1); opacity: 1; }
}

.daily-reward-icon {
    font-size: 4rem;
    margin-bottom: 15px;
}

.daily-reward-title {
    font-size: 1.5rem;
    font-weight: 700;
    margin-bottom: 10px;
}

.daily-streak {
    display: flex;
    justify-content: center;
    gap: 8px;
    margin: 20px 0;
}

.streak-day {
    width: 35px;
    height: 35px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.8rem;
    background: #e0e0e0;
}

.streak-day.claimed {
    background: var(--success);
    color: white;
}

.streak-day.today {
    background: var(--accent);
    animation: pulse 1s ease infinite;
}

/* ===== ACHIEVEMENTS ===== */
.achievement-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
}

.achievement-item {
    background: var(--card-bg);
    border-radius: 15px;
    padding: 15px;
    text-align: center;
    box-shadow: 0 3px 15px rgba(0,0,0,0.1);
    transition: transform 0.2s;
}

.achievement-item.locked {
    opacity: 0.5;
    filter: grayscale(1);
}

.achievement-icon {
    font-size: 2rem;
    margin-bottom: 8px;
}

.achievement-name {
    font-weight: 600;
    font-size: 0.85rem;
}

.achievement-desc {
    font-size: 0.7rem;
    color: var(--text-light);
    margin-top: 5px;
}

/* ===== SETTINGS ===== */
.settings-section {
    margin-bottom: 20px;
}

.settings-title {
    font-weight: 600;
    margin-bottom: 12px;
    font-size: 0.9rem;
    color: var(--text-light);
    text-transform: uppercase;
}

.setting-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 15px;
    background: var(--card-bg);
    border-radius: 15px;
    margin-bottom: 10px;
    box-shadow: 0 3px 10px rgba(0,0,0,0.05);
}

.setting-label {
    display: flex;
    align-items: center;
    gap: 12px;
}

.setting-icon {
    font-size: 1.3rem;
}

/* Toggle Switch */
.toggle {
    width: 55px;
    height: 30px;
    background: #e0e0e0;
    border-radius: 15px;
    position: relative;
    cursor: pointer;
    transition: background 0.3s;
}

.toggle.active {
    background: var(--success);
}

.toggle::after {
    content: '';
    position: absolute;
    width: 26px;
    height: 26px;
    background: white;
    border-radius: 50%;
    top: 2px;
    left: 2px;
    transition: transform 0.3s;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}

.toggle.active::after {
    transform: translateX(25px);
}

/* ===== MODAL ===== */
.modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    padding: 20px;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s;
}

.modal.active {
    opacity: 1;
    visibility: visible;
}

.modal-content {
    background: var(--card-bg);
    border-radius: var(--radius);
    padding: 25px;
    max-width: 350px;
    width: 100%;
    max-height: 80vh;
    overflow-y: auto;
    transform: scale(0.9);
    transition: transform 0.3s;
}

.modal.active .modal-content {
    transform: scale(1);
}

.modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 20px;
}

.modal-title {
    font-size: 1.3rem;
    font-weight: 700;
}

.modal-close {
    width: 35px;
    height: 35px;
    border-radius: 50%;
    border: none;
    background: #f0f0f0;
    font-size: 1.2rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* ===== LEVEL COMPLETE ===== */
.level-complete {
    text-align: center;
    padding: 20px;
}

.level-complete-icon {
    font-size: 5rem;
    margin-bottom: 15px;
}

.level-complete-title {
    font-size: 1.8rem;
    font-weight: 700;
    margin-bottom: 10px;
}

.level-complete-score {
    font-size: 2.5rem;
    font-weight: 700;
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin: 20px 0;
}

.stars-container {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin: 20px 0;
}

.star {
    font-size: 2.5rem;
    opacity: 0.3;
    transition: all 0.3s;
}

.star.earned {
    opacity: 1;
    animation: starPop 0.5s ease;
}

@keyframes starPop {
    0% { transform: scale(0) rotate(-180deg); }
    60% { transform: scale(1.3) rotate(20deg); }
    100% { transform: scale(1) rotate(0deg); }
}

/* ===== BOOSTERS ===== */
.boosters-bar {
    display: flex;
    gap: 10px;
    justify-content: center;
    padding: 10px;
}

.booster-btn {
    width: 55px;
    height: 55px;
    border-radius: 50%;
    background: var(--card-bg);
    border: 2px solid #e0e0e0;
    font-size: 1.5rem;
    position: relative;
    cursor: pointer;
    transition: all 0.2s;
}

.booster-btn:active {
    transform: scale(0.95);
}

.booster-btn.disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.booster-count {
    position: absolute;
    top: -5px;
    right: -5px;
    background: var(--danger);
    color: white;
    font-size: 0.7rem;
    width: 22px;
    height: 22px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
}

/* ===== COLORBLIND MODE ===== */
.colorblind .cell {
    font-size: 2.2rem;
}

/* ===== SCROLL ===== */
::-webkit-scrollbar {
    width: 6px;
}

::-webkit-scrollbar-track {
    background: transparent;
}

::-webkit-scrollbar-thumb {
    background: rgba(255,255,255,0.3);
    border-radius: 3px;
}

/* ===== TUTORIAL ===== */
.tutorial-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.9);
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 30px;
}

.tutorial-content {
    text-align: center;
    color: white;
    max-width: 300px;
}

.tutorial-icon {
    font-size: 4rem;
    margin-bottom: 20px;
}

.tutorial-text {
    font-size: 1.1rem;
    line-height: 1.6;
    margin-bottom: 25px;
}

.tutorial-dots {
    display: flex;
    justify-content: center;
    gap: 8px;
    margin-bottom: 20px;
}

.tutorial-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: rgba(255,255,255,0.3);
}

.tutorial-dot.active {
    background: white;
}
`;
document.head.appendChild(styles);

// ==================== DATABASE ====================
class Database {
    constructor() {
        this.dbName = 'SweetMatchDB';
        this.dbVersion = 1;
        this.db = null;
    }

    async init() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(this.dbName, this.dbVersion);
            
            request.onerror = () => reject(request.error);
            request.onsuccess = () => {
                this.db = request.result;
                resolve();
            };
            
            request.onupgradeneeded = (e) => {
                const db = e.target.result;
                
                if (!db.objectStoreNames.contains('profiles')) {
                    const profileStore = db.createObjectStore('profiles', { keyPath: 'id' });
                    profileStore.createIndex('name', 'name', { unique: false });
                }
                
                if (!db.objectStoreNames.contains('leaderboard')) {
                    db.createObjectStore('leaderboard', { keyPath: 'id' });
                }
                
                if (!db.objectStoreNames.contains('settings')) {
                    db.createObjectStore('settings', { keyPath: 'key' });
                }
            };
        });
    }

    async saveProfile(profile) {
        return new Promise((resolve, reject) => {
            const transaction = this.db.transaction(['profiles'], 'readwrite');
            const store = transaction.objectStore('profiles');
            const request = store.put(profile);
            request.onsuccess = () => resolve();
            request.onerror = () => reject(request.error);
        });
    }

    async getProfiles() {
        return new Promise((resolve, reject) => {
            const transaction = this.db.transaction(['profiles'], 'readonly');
            const store = transaction.objectStore('profiles');
            const request = store.getAll();
            request.onsuccess = () => resolve(request.result || []);
            request.onerror = () => reject(request.error);
        });
    }

    async deleteProfile(id) {
        return new Promise((resolve, reject) => {
            const transaction = this.db.transaction(['profiles'], 'readwrite');
            const store = transaction.objectStore('profiles');
            const request = store.delete(id);
            request.onsuccess = () => resolve();
            request.onerror = () => reject(request.error);
        });
    }

    async saveSetting(key, value) {
        return new Promise((resolve, reject) => {
            const transaction = this.db.transaction(['settings'], 'readwrite');
            const store = transaction.objectStore('settings');
            const request = store.put({ key, value });
            request.onsuccess = () => resolve();
            request.onerror = () => reject(request.error);
        });
    }

    async getSetting(key) {
        return new Promise((resolve, reject) => {
            const transaction = this.db.transaction(['settings'], 'readonly');
            const store = transaction.objectStore('settings');
            const request = store.get(key);
            request.onsuccess = () => resolve(request.result?.value);
            request.onerror = () => reject(request.error);
        });
    }
}

// ==================== CLOUD SYNC (Simulated) ====================
class CloudSync {
    constructor() {
        this.serverUrl = null; // Remplacer par URL r√©elle
        this.leaderboardKey = 'sweetmatch_global_leaderboard';
    }

    generateRecoveryCode() {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
        let code = '';
        for (let i = 0; i < 12; i++) {
            if (i > 0 && i % 4 === 0) code += '-';
            code += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return code;
    }

    async submitScore(profile) {
        // Simul√© avec localStorage pour d√©mo
        // En production, envoyer √† un serveur
        try {
            const leaderboard = JSON.parse(localStorage.getItem(this.leaderboardKey) || '[]');
            const existing = leaderboard.findIndex(e => e.id === profile.id);
            
            const entry = {
                id: profile.id,
                name: profile.name,
                avatar: profile.avatar,
                score: profile.highScore || profile.totalScore,
                level: profile.currentLevel,
                timestamp: Date.now()
            };
            
            if (existing >= 0) {
                if (entry.score > leaderboard[existing].score) {
                    leaderboard[existing] = entry;
                }
            } else {
                leaderboard.push(entry);
            }
            
            leaderboard.sort((a, b) => b.score - a.score);
            localStorage.setItem(this.leaderboardKey, JSON.stringify(leaderboard.slice(0, 100)));
            
            return true;
        } catch (e) {
            console.error('Cloud sync error:', e);
            return false;
        }
    }

    async getLeaderboard() {
        try {
            const leaderboard = JSON.parse(localStorage.getItem(this.leaderboardKey) || '[]');
            return leaderboard;
        } catch (e) {
            return [];
        }
    }
}

// ==================== AUDIO MANAGER ====================
class AudioManager {
    constructor() {
        this.enabled = true;
        this.musicEnabled = true;
        this.context = null;
    }

    init() {
        try {
            this.context = new (window.AudioContext || window.webkitAudioContext)();
        } catch (e) {
            console.log('Audio not supported');
        }
    }

    play(type) {
        if (!this.enabled || !this.context) return;
        
        try {
            const oscillator = this.context.createOscillator();
            const gainNode = this.context.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(this.context.destination);
            
            const sounds = {
                match: { freq: 523.25, duration: 0.15 },
                combo: { freq: 659.25, duration: 0.2 },
                select: { freq: 440, duration: 0.1 },
                win: { freq: 783.99, duration: 0.4 },
                fail: { freq: 220, duration: 0.3 }
            };
            
            const sound = sounds[type] || sounds.select;
            oscillator.frequency.value = sound.freq;
            gainNode.gain.setValueAtTime(0.3, this.context.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, this.context.currentTime + sound.duration);
            
            oscillator.start();
            oscillator.stop(this.context.currentTime + sound.duration);
        } catch (e) {}
    }

    toggle() {
        this.enabled = !this.enabled;
        return this.enabled;
    }
}

// ==================== GAME ENGINE ====================
class GameEngine {
    constructor() {
        this.grid = [];
        this.gridSize = CONFIG.GRID_SIZE;
        this.selectedCell = null;
        this.isAnimating = false;
        this.score = 0;
        this.moves = 0;
        this.targetScore = 0;
        this.combo = 0;
        this.level = 1;
        this.onScoreChange = null;
        this.onMovesChange = null;
        this.onGameEnd = null;
    }

    initLevel(level) {
        this.level = level;
        this.score = 0;
        this.moves = CONFIG.MOVES_BASE + Math.floor(level / 3) * 2;
        this.targetScore = 500 + (level * 200);
        this.combo = 0;
        this.selectedCell = null;
        this.grid = this.createGrid();
        
        // Ensure no initial matches
        while (this.findMatches().length > 0) {
            this.grid = this.createGrid();
        }
    }

    createGrid() {
        const grid = [];
        for (let row = 0; row < this.gridSize; row++) {
            grid[row] = [];
            for (let col = 0; col < this.gridSize; col++) {
                grid[row][col] = this.getRandomCandy();
            }
        }
        return grid;
    }

    getRandomCandy() {
        return Math.floor(Math.random() * CONFIG.CANDY_TYPES.length);
    }

    getCandyEmoji(type) {
        return CONFIG.CANDY_TYPES[type];
    }

    selectCell(row, col) {
        if (this.isAnimating || this.moves <= 0) return false;

        if (this.selectedCell) {
            const { row: sRow, col: sCol } = this.selectedCell;
            
            if (this.isAdjacent(sRow, sCol, row, col)) {
                this.swap(sRow, sCol, row, col);
                return true;
            } else {
                this.selectedCell = { row, col };
                return false;
            }
        } else {
            this.selectedCell = { row, col };
            return false;
        }
    }

    isAdjacent(r1, c1, r2, c2) {
        return (Math.abs(r1 - r2) + Math.abs(c1 - c2)) === 1;
    }

    async swap(r1, c1, r2, c2) {
        this.isAnimating = true;
        
        // Swap
        const temp = this.grid[r1][c1];
        this.grid[r1][c1] = this.grid[r2][c2];
        this.grid[r2][c2] = temp;

        const matches = this.findMatches();
        
        if (matches.length === 0) {
            // Swap back
            const temp = this.grid[r1][c1];
            this.grid[r1][c1] = this.grid[r2][c2];
            this.grid[r2][c2] = temp;
            this.selectedCell = null;
            this.isAnimating = false;
            return false;
        }

        this.moves--;
        if (this.onMovesChange) this.onMovesChange(this.moves);
        
        this.selectedCell = null;
        this.combo = 0;
        
        await this.processMatches();
        
        this.isAnimating = false;
        
        // Check win/lose
        if (this.score >= this.targetScore) {
            if (this.onGameEnd) this.onGameEnd(true, this.score);
        } else if (this.moves <= 0) {
            if (this.onGameEnd) this.onGameEnd(false, this.score);
        }
        
        return true;
    }

    findMatches() {
        const matches = [];
        
        // Horizontal
        for (let row = 0; row < this.gridSize; row++) {
            for (let col = 0; col < this.gridSize - 2; col++) {
                const type = this.grid[row][col];
                if (type !== null && 
                    this.grid[row][col + 1] === type && 
                    this.grid[row][col + 2] === type) {
                    let length = 3;
                    while (col + length < this.gridSize && this.grid[row][col + length] === type) {
                        length++;
                    }
                    for (let i = 0; i < length; i++) {
                        if (!matches.some(m => m.row === row && m.col === col + i)) {
                            matches.push({ row, col: col + i });
                        }
                    }
                }
            }
        }
        
        // Vertical
        for (let col = 0; col < this.gridSize; col++) {
            for (let row = 0; row < this.gridSize - 2; row++) {
                const type = this.grid[row][col];
                if (type !== null && 
                    this.grid[row + 1][col] === type && 
                    this.grid[row + 2][col] === type) {
                    let length = 3;
                    while (row + length < this.gridSize && this.grid[row + length][col] === type) {
                        length++;
                    }
                    for (let i = 0; i < length; i++) {
                        if (!matches.some(m => m.row === row + i && m.col === col)) {
                            matches.push({ row: row + i, col });
                        }
                    }
                }
            }
        }
        
        return matches;
    }

    async processMatches() {
        let matches = this.findMatches();
        
        while (matches.length > 0) {
            this.combo++;
            const baseScore = matches.length * CONFIG.SCORE_MULTIPLIER;
            const comboBonus = Math.floor(baseScore * (this.combo - 1) * (CONFIG.COMBO_MULTIPLIER - 1));
            this.score += baseScore + comboBonus;
            
            if (this.onScoreChange) this.onScoreChange(this.score, this.combo);
            
            // Mark matched
            for (const match of matches) {
                this.grid[match.row][match.col] = null;
            }
            
            await this.wait(200);
            
            // Fall
            this.applyGravity();
            await this.wait(200);
            
            // Fill
            this.fillEmpty();
            await this.wait(200);
            
            matches = this.findMatches();
        }
    }

    applyGravity() {
        for (let col = 0; col < this.gridSize; col++) {
            let writeRow = this.gridSize - 1;
            for (let row = this.gridSize - 1; row >= 0; row--) {
                if (this.grid[row][col] !== null) {
                    if (row !== writeRow) {
                        this.grid[writeRow][col] = this.grid[row][col];
                        this.grid[row][col] = null;
                    }
                    writeRow--;
                }
            }
        }
    }

    fillEmpty() {
        for (let col = 0; col < this.gridSize; col++) {
            for (let row = 0; row < this.gridSize; row++) {
                if (this.grid[row][col] === null) {
                    this.grid[row][col] = this.getRandomCandy();
                }
            }
        }
    }

    findHint() {
        for (let row = 0; row < this.gridSize; row++) {
            for (let col = 0; col < this.gridSize; col++) {
                // Try swap right
                if (col < this.gridSize - 1) {
                    this.swapTemp(row, col, row, col + 1);
                    if (this.findMatches().length > 0) {
                        this.swapTemp(row, col, row, col + 1);
                        return [{ row, col }, { row, col: col + 1 }];
                    }
                    this.swapTemp(row, col, row, col + 1);
                }
                // Try swap down
                if (row < this.gridSize - 1) {
                    this.swapTemp(row, col, row + 1, col);
                    if (this.findMatches().length > 0) {
                        this.swapTemp(row, col, row + 1, col);
                        return [{ row, col }, { row: row + 1, col }];
                    }
                    this.swapTemp(row, col, row + 1, col);
                }
            }
        }
        return null;
    }

    swapTemp(r1, c1, r2, c2) {
        const temp = this.grid[r1][c1];
        this.grid[r1][c1] = this.grid[r2][c2];
        this.grid[r2][c2] = temp;
    }

    shuffle() {
        for (let i = this.gridSize * this.gridSize - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            const r1 = Math.floor(i / this.gridSize);
            const c1 = i % this.gridSize;
            const r2 = Math.floor(j / this.gridSize);
            const c2 = j % this.gridSize;
            
            const temp = this.grid[r1][c1];
            this.grid[r1][c1] = this.grid[r2][c2];
            this.grid[r2][c2] = temp;
        }
        
        while (this.findMatches().length > 0) {
            this.processMatches();
        }
    }

    wait(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }
}

// ==================== APP ====================
class App {
    constructor() {
        this.db = new Database();
        this.cloud = new CloudSync();
        this.audio = new AudioManager();
        this.game = new GameEngine();
        
        this.currentProfile = null;
        this.profiles = [];
        this.settings = {
            darkMode: false,
            soundEnabled: true,
            musicEnabled: true,
            colorblindMode: false
        };
        
        this.touchStartX = 0;
        this.touchStartY = 0;
        this.touchStartCell = null;
    }

    async init() {
        await this.db.init();
        this.profiles = await this.db.getProfiles();
        
        // Load settings
        const savedSettings = await this.db.getSetting('appSettings');
        if (savedSettings) {
            this.settings = { ...this.settings, ...savedSettings };
        }
        
        this.audio.init();
        this.audio.enabled = this.settings.soundEnabled;
        
        this.applySettings();
        this.render();
        this.showScreen('profile-select');
    }

    applySettings() {
        document.body.classList.toggle('dark-mode', this.settings.darkMode);
        document.body.classList.toggle('colorblind', this.settings.colorblindMode);
    }

    async saveSettings() {
        await this.db.saveSetting('appSettings', this.settings);
    }

    render() {
        const app = document.getElementById('app');
        app.innerHTML = `
            <!-- Profile Selection Screen -->
            <div id="screen-profile-select" class="screen">
                <div class="header">
                    <h1>üç¨ Sweet Match</h1>
                    <button class="header-btn" onclick="app.showScreen('settings')">‚öôÔ∏è</button>
                </div>
                
                <div class="card">
                    <div class="card-title">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Choisir un profil</div>
                </div>
                
                <div class="profile-list" id="profile-list"></div>
                
                <button class="btn btn-primary btn-block" onclick="app.showCreateProfile()">
                    ‚ûï Nouveau profil
                </button>
            </div>

            <!-- Create Profile Screen -->
            <div id="screen-create-profile" class="screen">
                <div class="header">
                    <button class="header-btn" onclick="app.showScreen('profile-select')">‚Üê</button>
                    <h1>Nouveau profil</h1>
                    <div style="width:44px"></div>
                </div>
                
                <div class="card">
                    <div class="input-group">
                        <label>Pr√©nom</label>
                        <input type="text" id="profile-name" placeholder="Entre ton pr√©nom" maxlength="15">
                    </div>
                    
                    <label style="display:block;margin-bottom:10px;font-weight:500">Choisis ton avatar</label>
                    <div class="avatar-grid" id="avatar-grid"></div>
                    
                    <div class="setting-item" style="margin-top:15px">
                        <div class="setting-label">
                            <span class="setting-icon">üîí</span>
                            <span>Profil prot√©g√© (PIN)</span>
                        </div>
                        <div class="toggle" id="toggle-protected" onclick="app.toggleProtected()"></div>
                    </div>
                    
                    <div id="pin-setup" style="display:none">
                        <label style="display:block;margin:15px 0 10px;font-weight:500;text-align:center">
                            Code PIN √† 4 chiffres
                        </label>
                        <div class="pin-container">
                            <input type="tel" class="pin-digit" maxlength="1" data-pin="0">
                            <input type="tel" class="pin-digit" maxlength="1" data-pin="1">
                            <input type="tel" class="pin-digit" maxlength="1" data-pin="2">
                            <input type="tel" class="pin-digit" maxlength="1" data-pin="3">
                        </div>
                    </div>
                </div>
                
                <button class="btn btn-success btn-block" onclick="app.createProfile()">
                    ‚úì Cr√©er le profil
                </button>
            </div>

            <!-- PIN Entry Screen -->
            <div id="screen-pin-entry" class="screen">
                <div class="header">
                    <button class="header-btn" onclick="app.showScreen('profile-select')">‚Üê</button>
                    <h1>üîê Code PIN</h1>
                    <div style="width:44px"></div>
                </div>
                
                <div class="card" style="text-align:center">
                    <div id="pin-profile-info"></div>
                    <p style="margin:15px 0;color:var(--text-light)">Entre ton code PIN</p>
                    <div class="pin-container">
                        <input type="tel" class="pin-digit pin-entry" maxlength="1" data-pin="0">
                        <input type="tel" class="pin-digit pin-entry" maxlength="1" data-pin="1">
                        <input type="tel" class="pin-digit pin-entry" maxlength="1" data-pin="2">
                        <input type="tel" class="pin-digit pin-entry" maxlength="1" data-pin="3">
                    </div>
                    <p id="pin-error" style="color:var(--danger);margin-top:15px;display:none">
                        Code incorrect
                    </p>
                </div>
            </div>

            <!-- Main Menu Screen -->
            <div id="screen-main-menu" class="screen">
                <div class="header">
                    <button class="header-btn" onclick="app.switchProfile()">üë§</button>
                    <h1>üç¨ Sweet Match</h1>
                    <button class="header-btn" onclick="app.showScreen('settings')">‚öôÔ∏è</button>
                </div>
                
                <div class="card">
                    <div style="display:flex;align-items:center;gap:15px">
                        <img id="menu-avatar" class="profile-avatar" style="width:60px;height:60px">
                        <div>
                            <div id="menu-name" style="font-weight:600;font-size:1.2rem"></div>
                            <div id="menu-stats" style="color:var(--text-light);font-size:0.9rem"></div>
                        </div>
                    </div>
                </div>
                
                <button class="btn btn-primary btn-block" onclick="app.showScreen('level-map')" style="margin-bottom:15px">
                    üéÆ Jouer
                </button>
                
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
                    <button class="btn btn-secondary" onclick="app.showScreen('leaderboard')">
                        üèÜ Classement
                    </button>
                    <button class="btn btn-secondary" onclick="app.showScreen('achievements')">
                        ‚≠ê Succ√®s
                    </button>
                    <button class="btn btn-secondary" onclick="app.showScreen('daily')">
                        üéÅ R√©compenses
                    </button>
                    <button class="btn btn-secondary" onclick="app.showScreen('profile-settings')">
                        üë§ Profil
                    </button>
                </div>
            </div>

            <!-- Level Map Screen -->
            <div id="screen-level-map" class="screen">
                <div class="header">
                    <button class="header-btn" onclick="app.showScreen('main-menu')">‚Üê</button>
                    <h1>Niveaux</h1>
                    <div style="width:44px"></div>
                </div>
                
                <div class="level-map" id="level-map"></div>
            </div>

            <!-- Game Screen -->
            <div id="screen-game" class="screen">
                <div class="header">
                    <button class="header-btn" onclick="app.exitGame()">‚úï</button>
                    <h1 id="game-level">Niveau 1</h1>
                    <button class="header-btn" onclick="app.showHint()">üí°</button>
                </div>
                
                <div class="game-container">
                    <div class="game-stats">
                        <div class="stat-box">
                            <div class="stat-value" id="stat-score">0</div>
                            <div class="stat-label">Score</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="stat-target">500</div>
                            <div class="stat-label">Objectif</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="stat-moves">20</div>
                            <div class="stat-label">Coups</div>
                        </div>
                    </div>
                    
                    <div class="game-board">
                        <div class="grid" id="game-grid"></div>
                    </div>
                    
                    <div class="boosters-bar">
                        <button class="booster-btn" onclick="app.useBooster('shuffle')" id="booster-shuffle">
                            üîÄ
                            <span class="booster-count" id="booster-shuffle-count">3</span>
                        </button>
                        <button class="booster-btn" onclick="app.useBooster('hammer')" id="booster-hammer">
                            üî®
                            <span class="booster-count" id="booster-hammer-count">2</span>
                        </button>
                        <button class="booster-btn" onclick="app.useBooster('extra')" id="booster-extra">
                            ‚ûï
                            <span class="booster-count" id="booster-extra-count">1</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Leaderboard Screen -->
            <div id="screen-leaderboard" class="screen">
                <div class="header">
                    <button class="header-btn" onclick="app.showScreen('main-menu')">‚Üê</button>
                    <h1>üèÜ Classement</h1>
                    <button class="header-btn" onclick="app.refreshLeaderboard()">üîÑ</button>
                </div>
                
                <div class="card">
                    <div class="card-title">üåç Classement mondial</div>
                    <div class="leaderboard-list" id="leaderboard-list"></div>
                </div>
            </div>

            <!-- Achievements Screen -->
            <div id="screen-achievements" class="screen">
                <div class="header">
                    <button class="header-btn" onclick="app.showScreen('main-menu')">‚Üê</button>
                    <h1>‚≠ê Succ√®s</h1>
                    <div style="width:44px"></div>
                </div>
                
                <div class="achievement-grid" id="achievement-grid"></div>
            </div>

            <!-- Daily Rewards Screen -->
            <div id="screen-daily" class="screen">
                <div class="header">
                    <button class="header-btn" onclick="app.showScreen('main-menu')">‚Üê</button>
                    <h1>üéÅ R√©compenses</h1>
                    <div style="width:44px"></div>
                </div>
                
                <div class="card" style="text-align:center">
                    <div class="card-title" style="justify-content:center">üìÖ Connexion quotidienne</div>
                    <div id="daily-streak-info"></div>
                    <div class="daily-streak" id="daily-streak"></div>
                    <button class="btn btn-success" id="claim-daily" onclick="app.claimDailyReward()">
                        R√©cup√©rer !
                    </button>
                </div>
                
                <div class="card">
                    <div class="card-title">üéØ D√©fis du jour</div>
                    <div id="daily-challenges"></div>
                </div>
            </div>

            <!-- Profile Settings Screen -->
            <div id="screen-profile-settings" class="screen">
                <div class="header">
                    <button class="header-btn" onclick="app.showScreen('main-menu')">‚Üê</button>
                    <h1>üë§ Mon profil</h1>
                    <div style="width:44px"></div>
                </div>
                
                <div class="card" id="profile-details"></div>
                
                <div class="card">
                    <div class="card-title">‚òÅÔ∏è Sauvegarde cloud</div>
                    <p style="font-size:0.9rem;color:var(--text-light);margin-bottom:15px">
                        Code de r√©cup√©ration pour restaurer ton profil
                    </p>
                    <div id="recovery-code" style="font-family:monospace;font-size:1.2rem;text-align:center;padding:15px;background:#f0f0f0;border-radius:10px"></div>
                    <button class="btn btn-secondary btn-block btn-sm" style="margin-top:15px" onclick="app.copyRecoveryCode()">
                        üìã Copier le code
                    </button>
                </div>
                
                <button class="btn btn-danger btn-block" onclick="app.confirmDeleteProfile()" style="margin-top:15px">
                    üóëÔ∏è Supprimer ce profil
                </button>
            </div>

            <!-- Settings Screen -->
            <div id="screen-settings" class="screen">
                <div class="header">
                    <button class="header-btn" onclick="app.goBack()">‚Üê</button>
                    <h1>‚öôÔ∏è Param√®tres</h1>
                    <div style="width:44px"></div>
                </div>
                
                <div class="settings-section">
                    <div class="settings-title">Audio</div>
                    <div class="setting-item">
                        <div class="setting-label">
                            <span class="setting-icon">üîä</span>
                            <span>Sons</span>
                        </div>
                        <div class="toggle ${this.settings.soundEnabled ? 'active' : ''}" onclick="app.toggleSetting('soundEnabled')"></div>
                    </div>
                    <div class="setting-item">
                        <div class="setting-label">
                            <span class="setting-icon">üéµ</span>
                            <span>Musique</span>
                        </div>
                        <div class="toggle ${this.settings.musicEnabled ? 'active' : ''}" onclick="app.toggleSetting('musicEnabled')"></div>
                    </div>
                </div>
                
                <div class="settings-section">
                    <div class="settings-title">Affichage</div>
                    <div class="setting-item">
                        <div class="setting-label">
                            <span class="setting-icon">üåô</span>
                            <span>Mode sombre</span>
                        </div>
                        <div class="toggle ${this.settings.darkMode ? 'active' : ''}" onclick="app.toggleSetting('darkMode')"></div>
                    </div>
                    <div class="setting-item">
                        <div class="setting-label">
                            <span class="setting-icon">üëÅÔ∏è</span>
                            <span>Mode daltonien</span>
                        </div>
                        <div class="toggle ${this.settings.colorblindMode ? 'active' : ''}" onclick="app.toggleSetting('colorblindMode')"></div>
                    </div>
                </div>
                
                <div class="card" style="text-align:center;margin-top:20px">
                    <p style="font-size:0.9rem;color:var(--text-light)">
                        üç¨ Sweet Match v1.0<br>
                        Un jeu pour toute la famille
                    </p>
                </div>
            </div>

            <!-- Modals -->
            <div class="modal" id="modal-level-complete">
                <div class="modal-content">
                    <div class="level-complete">
                        <div class="level-complete-icon" id="complete-icon">üéâ</div>
                        <div class="level-complete-title" id="complete-title">Niveau r√©ussi !</div>
                        <div class="stars-container" id="stars-container"></div>
                        <div class="level-complete-score" id="complete-score">0</div>
                        <p style="color:var(--text-light)">points</p>
                        <div style="display:flex;gap:10px;margin-top:25px">
                            <button class="btn btn-secondary" onclick="app.exitGame()" style="flex:1">
                                Menu
                            </button>
                            <button class="btn btn-primary" onclick="app.nextLevel()" style="flex:1" id="next-level-btn">
                                Suivant
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal" id="modal-confirm">
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="modal-title" id="confirm-title">Confirmer</div>
                        <button class="modal-close" onclick="app.closeModal('modal-confirm')">√ó</button>
                    </div>
                    <p id="confirm-message" style="margin-bottom:20px"></p>
                    <div id="confirm-pin-input" style="display:none">
                        <div class="pin-container">
                            <input type="tel" class="pin-digit confirm-pin" maxlength="1" data-pin="0">
                            <input type="tel" class="pin-digit confirm-pin" maxlength="1" data-pin="1">
                            <input type="tel" class="pin-digit confirm-pin" maxlength="1" data-pin="2">
                            <input type="tel" class="pin-digit confirm-pin" maxlength="1" data-pin="3">
                        </div>
                        <p id="confirm-pin-error" style="color:var(--danger);text-align:center;margin-top:10px;display:none">
                            Code PIN incorrect
                        </p>
                    </div>
                    <div style="display:flex;gap:10px">
                        <button class="btn btn-secondary" onclick="app.closeModal('modal-confirm')" style="flex:1">
                            Annuler
                        </button>
                        <button class="btn btn-danger" id="confirm-action-btn" style="flex:1">
                            Confirmer
                        </button>
                    </div>
                </div>
            </div>

            <!-- Tutorial Overlay -->
            <div class="tutorial-overlay" id="tutorial" style="display:none">
                <div class="tutorial-content">
                    <div class="tutorial-icon" id="tutorial-icon">üëÜ</div>
                    <div class="tutorial-text" id="tutorial-text"></div>
                    <div class="tutorial-dots" id="tutorial-dots"></div>
                    <button class="btn btn-primary" onclick="app.nextTutorialStep()">Suivant</button>
                </div>
            </div>

            <!-- Daily Reward Popup -->
            <div class="daily-reward-modal" id="daily-reward-popup" style="display:none">
                <div class="daily-reward-content">
                    <div class="daily-reward-icon">üéÅ</div>
                    <div class="daily-reward-title">R√©compense quotidienne !</div>
                    <p style="color:var(--text-light)">Tu as re√ßu :</p>
                    <div style="font-size:2rem;margin:20px 0" id="daily-reward-amount"></div>
                    <button class="btn btn-success btn-block" onclick="app.closeDailyRewardPopup()">
                        Super !
                    </button>
                </div>
            </div>
        `;

        this.renderProfileList();
        this.renderAvatarGrid();
        this.setupPinInputs();
    }

    renderProfileList() {
        const list = document.getElementById('profile-list');
        if (!list) return;
        
        if (this.profiles.length === 0) {
            list.innerHTML = `
                <div style="text-align:center;padding:40px;color:var(--text-light)">
                    <div style="font-size:3rem;margin-bottom:15px">üëã</div>
                    <p>Aucun profil pour l'instant.<br>Cr√©e le tien pour commencer !</p>
                </div>
            `;
            return;
        }
        
        list.innerHTML = this.profiles.map(profile => `
            <div class="profile-card" onclick="app.selectProfile('${profile.id}')">
                <div class="profile-avatar">
                    <img src="${profile.avatar}" alt="${profile.name}">
                </div>
                <div class="profile-info">
                    <div class="profile-name">
                        ${profile.name}
                        ${profile.protected ? '<span class="protected-badge">üîí</span>' : ''}
                    </div>
                    <div class="profile-stats">
                        Niveau ${profile.currentLevel} ‚Ä¢ ${profile.totalScore} pts
                    </div>
                </div>
                <div class="profile-badge">
                    ${profile.currentLevel >= 10 ? 'üëë' : profile.currentLevel >= 5 ? '‚≠ê' : 'üåü'}
                </div>
            </div>
        `).join('');
    }

    renderAvatarGrid() {
        const grid = document.getElementById('avatar-grid');
        if (!grid) return;
        
        grid.innerHTML = AVATARS.map((url, i) => `
            <div class="avatar-option ${i === 0 ? 'selected' : ''}" onclick="app.selectAvatar(${i})" data-avatar="${i}">
                <img src="${url}" alt="Avatar ${i + 1}">
            </div>
        `).join('');
        
        this.selectedAvatar = 0;
    }

    selectAvatar(index) {
        document.querySelectorAll('.avatar-option').forEach((el, i) => {
            el.classList.toggle('selected', i === index);
        });
        this.selectedAvatar = index;
        this.audio.play('select');
    }

    toggleProtected() {
        const toggle = document.getElementById('toggle-protected');
        const pinSetup = document.getElementById('pin-setup');
        toggle.classList.toggle('active');
        pinSetup.style.display = toggle.classList.contains('active') ? 'block' : 'none';
    }

    setupPinInputs() {
        document.querySelectorAll('.pin-digit').forEach(input => {
            input.addEventListener('input', (e) => {
                const value = e.target.value.replace(/[^0-9]/g, '');
                e.target.value = value;
                
                if (value && e.target.dataset.pin < 3) {
                    const next = e.target.parentElement.querySelector(`[data-pin="${parseInt(e.target.dataset.pin) + 1}"]`);
                    if (next) next.focus();
                }
                
                // Check if all digits entered for PIN entry
                if (e.target.classList.contains('pin-entry')) {
                    this.checkPinEntry();
                }
                if (e.target.classList.contains('confirm-pin')) {
                    this.checkConfirmPin();
                }
            });
            
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Backspace' && !e.target.value && e.target.dataset.pin > 0) {
                    const prev = e.target.parentElement.querySelector(`[data-pin="${parseInt(e.target.dataset.pin) - 1}"]`);
                    if (prev) {
                        prev.focus();
                        prev.value = '';
                    }
                }
            });
        });
    }

    getPin(className = 'pin-digit') {
        const inputs = document.querySelectorAll(`.${className}`);
        let pin = '';
        inputs.forEach(input => pin += input.value);
        return pin;
    }

    clearPinInputs(className = 'pin-digit') {
        document.querySelectorAll(`.${className}`).forEach(input => input.value = '');
        const first = document.querySelector(`.${className}[data-pin="0"]`);
        if (first) first.focus();
    }

    async createProfile() {
        const name = document.getElementById('profile-name').value.trim();
        if (!name) {
            alert('Entre ton pr√©nom !');
            return;
        }
        
        const isProtected = document.getElementById('toggle-protected').classList.contains('active');
        let pin = null;
        
        if (isProtected) {
            pin = this.getPin();
            if (pin.length !== 4) {
                alert('Entre un code PIN √† 4 chiffres');
                return;
            }
        }
        
        const profile = {
            id: 'profile_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
            name: name,
            avatar: AVATARS[this.selectedAvatar],
            protected: isProtected,
            pin: pin,
            recoveryCode: this.cloud.generateRecoveryCode(),
            currentLevel: 1,
            totalScore: 0,
            highScore: 0,
            totalMatches: 0,
            maxCombo: 0,
            dailyStreak: 0,
            lastDaily: null,
            boosters: { shuffle: 3, hammer: 2, extra: 1 },
            achievements: [],
            levelScores: {},
            createdAt: Date.now()
        };
        
        await this.db.saveProfile(profile);
        this.profiles.push(profile);
        
        this.audio.play('win');
        this.showScreen('profile-select');
        this.renderProfileList();
    }

    selectProfile(id) {
        const profile = this.profiles.find(p => p.id === id);
        if (!profile) return;
        
        if (profile.protected) {
            this.pendingProfile = profile;
            this.showPinEntry(profile);
        } else {
            this.loginProfile(profile);
        }
    }

    showPinEntry(profile) {
        document.getElementById('pin-profile-info').innerHTML = `
            <img src="${profile.avatar}" style="width:80px;height:80px;border-radius:50%;margin-bottom:10px">
            <div style="font-weight:600;font-size:1.2rem">${profile.name}</div>
        `;
        document.getElementById('pin-error').style.display = 'none';
        this.clearPinInputs('pin-entry');
        this.showScreen('pin-entry');
        setTimeout(() => {
            document.querySelector('.pin-entry[data-pin="0"]').focus();
        }, 100);
    }

    checkPinEntry() {
        const pin = this.getPin('pin-entry');
        if (pin.length === 4) {
            if (this.pendingProfile && pin === this.pendingProfile.pin) {
                this.audio.play('win');
                this.loginProfile(this.pendingProfile);
            } else {
                this.audio.play('fail');
                document.getElementById('pin-error').style.display = 'block';
                this.clearPinInputs('pin-entry');
            }
        }
    }

    loginProfile(profile) {
        this.currentProfile = profile;
        this.checkDailyReward();
        this.updateMainMenu();
        this.showScreen('main-menu');
        this.cloud.submitScore(profile);
    }

    checkDailyReward() {
        const today = new Date().toDateString();
        const last = this.currentProfile.lastDaily;
        
        if (last !== today) {
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            
            if (last === yesterday.toDateString()) {
                this.currentProfile.dailyStreak++;
            } else if (last !== today) {
                this.currentProfile.dailyStreak = 1;
            }
            
            this.showDailyRewardPopup();
        }
    }

    showDailyRewardPopup() {
        const rewards = ['üéÅ 1 Shuffle', 'üî® 1 Hammer', '‚ûï 3 Coups', 'üéÅ 2 Shuffles', 'üî® 2 Hammers', '‚ûï 5 Coups', 'üåü Pack Complet!'];
        const day = Math.min(this.currentProfile.dailyStreak, 7);
        
        document.getElementById('daily-reward-amount').textContent = rewards[day - 1];
        document.getElementById('daily-reward-popup').style.display = 'flex';
        
        // Give reward
        if (day <= 2 || day === 4) this.currentProfile.boosters.shuffle += day <= 2 ? 1 : 2;
        if (day === 2 || day === 5) this.currentProfile.boosters.hammer += day === 5 ? 2 : 1;
        if (day === 3 || day === 6) this.currentProfile.boosters.extra += day === 6 ? 2 : 1;
        if (day === 7) {
            this.currentProfile.boosters.shuffle += 3;
            this.currentProfile.boosters.hammer += 3;
            this.currentProfile.boosters.extra += 3;
        }
        
        this.currentProfile.lastDaily = new Date().toDateString();
        this.saveCurrentProfile();
    }

    closeDailyRewardPopup() {
        document.getElementById('daily-reward-popup').style.display = 'none';
    }

    updateMainMenu() {
        if (!this.currentProfile) return;
        
        document.getElementById('menu-avatar').src = this.currentProfile.avatar;
        document.getElementById('menu-name').textContent = this.currentProfile.name;
        document.getElementById('menu-stats').textContent = 
            `Niveau ${this.currentProfile.currentLevel} ‚Ä¢ ${this.currentProfile.totalScore} pts`;
    }

    showScreen(screenId) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        const screen = document.getElementById(`screen-${screenId}`);
        if (screen) {
            screen.classList.add('active');
            
            // Screen-specific setup
            if (screenId === 'level-map') this.renderLevelMap();
            if (screenId === 'leaderboard') this.renderLeaderboard();
            if (screenId === 'achievements') this.renderAchievements();
            if (screenId === 'daily') this.renderDailyRewards();
            if (screenId === 'profile-settings') this.renderProfileSettings();
            if (screenId === 'profile-select') this.renderProfileList();
            if (screenId === 'settings') this.renderSettings();
        }
        
        this.previousScreen = this.currentScreen;
        this.currentScreen = screenId;
    }

    goBack() {
        if (this.currentProfile) {
            this.showScreen('main-menu');
        } else {
            this.showScreen('profile-select');
        }
    }

    switchProfile() {
        this.currentProfile = null;
        this.showScreen('profile-select');
    }

    showCreateProfile() {
        document.getElementById('profile-name').value = '';
        this.selectedAvatar = 0;
        this.renderAvatarGrid();
        document.getElementById('toggle-protected').classList.remove('active');
        document.getElementById('pin-setup').style.display = 'none';
        this.showScreen('create-profile');
    }

    renderLevelMap() {
        const map = document.getElementById('level-map');
        let html = '<div class="level-path">';
        
        for (let i = CONFIG.LEVELS; i >= 1; i--) {
            const isCompleted = i < this.currentProfile.currentLevel;
            const isCurrent = i === this.currentProfile.currentLevel;
            const isLocked = i > this.currentProfile.currentLevel;
            
            let levelClass = 'level-node';
            if (isCompleted) levelClass += ' completed';
            if (isCurrent) levelClass += ' current';
            if (isLocked) levelClass += ' locked';
            
            html += `
                <div class="${levelClass}" onclick="app.startLevel(${i})">
                    ${isLocked ? '' : i}
                </div>
            `;
            
            if (i > 1) {
                html += '<div class="level-connector"></div>';
            }
        }
        
        html += '</div>';
        map.innerHTML = html;
        
        // Scroll to current level
        setTimeout(() => {
            const current = map.querySelector('.current');
            if (current) {
                current.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }, 100);
    }

    startLevel(level) {
        if (level > this.currentProfile.currentLevel) return;
        
        this.game.initLevel(level);
        this.game.onScoreChange = (score, combo) => this.updateGameUI(score, combo);
        this.game.onMovesChange = (moves) => this.updateMoves(moves);
        this.game.onGameEnd = (won, score) => this.endLevel(won, score);
        
        document.getElementById('game-level').textContent = `Niveau ${level}`;
        document.getElementById('stat-score').textContent = '0';
        document.getElementById('stat-target').textContent = this.game.targetScore;
        document.getElementById('stat-moves').textContent = this.game.moves;
        
        this.updateBoosterUI();
        this.renderGameGrid();
        this.showScreen('game');
        
        // Show tutorial for first level
        if (level === 1 && !this.currentProfile.tutorialDone) {
            this.showTutorial();
        }
    }

    renderGameGrid() {
        const grid = document.getElementById('game-grid');
        const size = this.game.gridSize;
        const cellSize = Math.min((window.innerWidth - 60) / size, 45);
        
        grid.style.gridTemplateColumns = `repeat(${size}, ${cellSize}px)`;
        
        let html = '';
        for (let row = 0; row < size; row++) {
            for (let col = 0; col < size; col++) {
                const candy = this.game.grid[row][col];
                const emoji = this.game.getCandyEmoji(candy);
                const selected = this.game.selectedCell && 
                    this.game.selectedCell.row === row && 
                    this.game.selectedCell.col === col;
                
                html += `
                    <div class="cell ${selected ? 'selected' : ''}" 
                         style="width:${cellSize}px;height:${cellSize}px;font-size:${cellSize * 0.6}px"
                         data-row="${row}" data-col="${col}"
                         ontouchstart="app.onCellTouchStart(event, ${row}, ${col})"
                         ontouchmove="app.onCellTouchMove(event)"
                         ontouchend="app.onCellTouchEnd(event, ${row}, ${col})">
                        ${emoji}
                    </div>
                `;
            }
        }
        grid.innerHTML = html;
    }

    onCellTouchStart(e, row, col) {
        e.preventDefault();
        const touch = e.touches[0];
        this.touchStartX = touch.clientX;
        this.touchStartY = touch.clientY;
        this.touchStartCell = { row, col };
    }

    onCellTouchMove(e) {
        e.preventDefault();
    }

    async onCellTouchEnd(e, row, col) {
        if (!this.touchStartCell) return;
        
        const touch = e.changedTouches[0];
        const dx = touch.clientX - this.touchStartX;
        const dy = touch.clientY - this.touchStartY;
        
        const threshold = 30;
        let targetRow = this.touchStartCell.row;
        let targetCol = this.touchStartCell.col;
        
        if (Math.abs(dx) > Math.abs(dy) && Math.abs(dx) > threshold) {
            targetCol += dx > 0 ? 1 : -1;
        } else if (Math.abs(dy) > threshold) {
            targetRow += dy > 0 ? 1 : -1;
        } else {
            // Tap - select cell
            this.game.selectCell(row, col);
            this.audio.play('select');
            this.renderGameGrid();
            return;
        }
        
        // Swipe
        if (targetRow >= 0 && targetRow < this.game.gridSize &&
            targetCol >= 0 && targetCol < this.game.gridSize) {
            
            const swapped = await this.game.swap(
                this.touchStartCell.row, this.touchStartCell.col,
                targetRow, targetCol
            );
            
            if (swapped) {
                this.audio.play('match');
            }
            this.renderGameGrid();
        }
        
        this.touchStartCell = null;
    }

    updateGameUI(score, combo) {
        document.getElementById('stat-score').textContent = score;
        
        if (combo > 1) {
            this.audio.play('combo');
            // Show combo indicator
        }
    }

    updateMoves(moves) {
        document.getElementById('stat-moves').textContent = moves;
    }

    updateBoosterUI() {
        const p = this.currentProfile;
        document.getElementById('booster-shuffle-count').textContent = p.boosters.shuffle;
        document.getElementById('booster-hammer-count').textContent = p.boosters.hammer;
        document.getElementById('booster-extra-count').textContent = p.boosters.extra;
        
        document.getElementById('booster-shuffle').classList.toggle('disabled', p.boosters.shuffle <= 0);
        document.getElementById('booster-hammer').classList.toggle('disabled', p.boosters.hammer <= 0);
        document.getElementById('booster-extra').classList.toggle('disabled', p.boosters.extra <= 0);
    }

    useBooster(type) {
        const p = this.currentProfile;
        
        if (type === 'shuffle' && p.boosters.shuffle > 0) {
            p.boosters.shuffle--;
            this.game.shuffle();
            this.renderGameGrid();
        } else if (type === 'extra' && p.boosters.extra > 0) {
            p.boosters.extra--;
            this.game.moves += 5;
            this.updateMoves(this.game.moves);
        }
        
        this.updateBoosterUI();
        this.saveCurrentProfile();
    }

    showHint() {
        const hint = this.game.findHint();
        if (hint) {
            hint.forEach(cell => {
                const cellEl = document.querySelector(`[data-row="${cell.row}"][data-col="${cell.col}"]`);
                if (cellEl) {
                    cellEl.classList.add('hint');
                    setTimeout(() => cellEl.classList.remove('hint'), 2000);
                }
            });
        }
    }

    endLevel(won, score) {
        this.audio.play(won ? 'win' : 'fail');
        
        const stars = won ? Math.min(3, Math.floor(score / this.game.targetScore * 2) + 1) : 0;
        
        document.getElementById('complete-icon').textContent = won ? 'üéâ' : 'üò¢';
        document.getElementById('complete-title').textContent = won ? 'Niveau r√©ussi !' : 'Dommage...';
        document.getElementById('complete-score').textContent = score;
        
        let starsHtml = '';
        for (let i = 0; i < 3; i++) {
            starsHtml += `<span class="star ${i < stars ? 'earned' : ''}">‚≠ê</span>`;
        }
        document.getElementById('stars-container').innerHTML = starsHtml;
        
        document.getElementById('next-level-btn').style.display = won ? 'block' : 'none';
        
        if (won) {
            this.currentProfile.totalScore += score;
            if (score > (this.currentProfile.highScore || 0)) {
                this.currentProfile.highScore = score;
            }
            if (this.game.level === this.currentProfile.currentLevel) {
                this.currentProfile.currentLevel++;
            }
            this.currentProfile.levelScores[this.game.level] = Math.max(
                this.currentProfile.levelScores[this.game.level] || 0,
                score
            );
            if (this.game.combo > this.currentProfile.maxCombo) {
                this.currentProfile.maxCombo = this.game.combo;
            }
            this.currentProfile.totalMatches++;
            
            this.checkAchievements();
            this.saveCurrentProfile();
            this.cloud.submitScore(this.currentProfile);
        }
        
        this.showModal('modal-level-complete');
    }

    nextLevel() {
        this.closeModal('modal-level-complete');
        this.startLevel(this.game.level + 1);
    }

    exitGame() {
        this.closeModal('modal-level-complete');
        this.showScreen('level-map');
    }

    async renderLeaderboard() {
        const list = document.getElementById('leaderboard-list');
        const leaderboard = await this.cloud.getLeaderboard();
        
        if (leaderboard.length === 0) {
            list.innerHTML = '<p style="text-align:center;color:var(--text-light);padding:20px">Aucun score pour l\'instant</p>';
            return;
        }
        
        list.innerHTML = leaderboard.slice(0, 20).map((entry, i) => {
            const isCurrentUser = this.currentProfile && entry.id === this.currentProfile.id;
            let rankClass = 'rank-other';
            if (i === 0) rankClass = 'rank-1';
            if (i === 1) rankClass = 'rank-2';
            if (i === 2) rankClass = 'rank-3';
            
            return `
                <div class="leaderboard-item ${isCurrentUser ? 'current-user' : ''}">
                    <div class="leaderboard-rank ${rankClass}">${i + 1}</div>
                    <img class="leaderboard-avatar" src="${entry.avatar}" alt="${entry.name}">
                    <div class="leaderboard-info">
                        <div class="leaderboard-name">${entry.name} ${isCurrentUser ? '(toi)' : ''}</div>
                        <div class="leaderboard-level">Niveau ${entry.level}</div>
                    </div>
                    <div class="leaderboard-score">${entry.score}</div>
                </div>
            `;
        }).join('');
    }

    async refreshLeaderboard() {
        await this.cloud.submitScore(this.currentProfile);
        await this.renderLeaderboard();
    }

    renderAchievements() {
        const grid = document.getElementById('achievement-grid');
        
        grid.innerHTML = ACHIEVEMENTS.map(ach => {
            const unlocked = this.currentProfile.achievements.includes(ach.id);
            return `
                <div class="achievement-item ${unlocked ? '' : 'locked'}">
                    <div class="achievement-icon">${ach.name.split(' ')[0]}</div>
                    <div class="achievement-name">${ach.name.split(' ').slice(1).join(' ')}</div>
                    <div class="achievement-desc">${ach.desc}</div>
                </div>
            `;
        }).join('');
    }

    checkAchievements() {
        ACHIEVEMENTS.forEach(ach => {
            if (!this.currentProfile.achievements.includes(ach.id) && ach.condition(this.currentProfile)) {
                this.currentProfile.achievements.push(ach.id);
                // Show achievement notification
            }
        });
    }

    renderDailyRewards() {
        const streak = this.currentProfile.dailyStreak;
        const today = new Date().toDateString();
        const claimedToday = this.currentProfile.lastDaily === today;
        
        document.getElementById('daily-streak-info').innerHTML = `
            <p style="font-size:1.5rem;font-weight:700;margin:10px 0">üî• ${streak} jours</p>
        `;
        
        let streakHtml = '';
        for (let i = 1; i <= 7; i++) {
            const claimed = i <= streak;
            const isToday = i === streak + 1 && !claimedToday;
            streakHtml += `<div class="streak-day ${claimed ? 'claimed' : ''} ${isToday ? 'today' : ''}">${i}</div>`;
        }
        document.getElementById('daily-streak').innerHTML = streakHtml;
        
        const claimBtn = document.getElementById('claim-daily');
        claimBtn.disabled = claimedToday;
        claimBtn.textContent = claimedToday ? '‚úì R√©cup√©r√©' : 'R√©cup√©rer !';
        
        document.getElementById('daily-challenges').innerHTML = `
            <div style="padding:10px;background:#f8f9fa;border-radius:10px;margin-bottom:10px">
                <div style="display:flex;justify-content:space-between">
                    <span>üéØ Fais 5 matchs de 4+</span>
                    <span>0/5</span>
                </div>
                <div style="background:#e0e0e0;height:6px;border-radius:3px;margin-top:8px">
                    <div style="background:var(--primary);height:100%;width:0%;border-radius:3px"></div>
                </div>
            </div>
            <div style="padding:10px;background:#f8f9fa;border-radius:10px">
                <div style="display:flex;justify-content:space-between">
                    <span>‚≠ê Termine 3 niveaux</span>
                    <span>0/3</span>
                </div>
                <div style="background:#e0e0e0;height:6px;border-radius:3px;margin-top:8px">
                    <div style="background:var(--primary);height:100%;width:0%;border-radius:3px"></div>
                </div>
            </div>
        `;
    }

    claimDailyReward() {
        if (this.currentProfile.lastDaily === new Date().toDateString()) return;
        this.showDailyRewardPopup();
    }

    renderProfileSettings() {
        const p = this.currentProfile;
        
        document.getElementById('profile-details').innerHTML = `
            <div style="display:flex;align-items:center;gap:20px">
                <img src="${p.avatar}" style="width:80px;height:80px;border-radius:50%">
                <div>
                    <div style="font-size:1.5rem;font-weight:700">${p.name}</div>
                    <div style="color:var(--text-light)">
                        ${p.protected ? 'üîí Profil prot√©g√©' : 'üîì Profil non prot√©g√©'}
                    </div>
                </div>
            </div>
            <div style="margin-top:20px;display:grid;grid-template-columns:repeat(3,1fr);gap:10px;text-align:center">
                <div>
                    <div style="font-size:1.5rem;font-weight:700">${p.currentLevel}</div>
                    <div style="font-size:0.8rem;color:var(--text-light)">Niveau</div>
                </div>
                <div>
                    <div style="font-size:1.5rem;font-weight:700">${p.totalScore}</div>
                    <div style="font-size:0.8rem;color:var(--text-light)">Score total</div>
                </div>
                <div>
                    <div style="font-size:1.5rem;font-weight:700">${p.achievements.length}</div>
                    <div style="font-size:0.8rem;color:var(--text-light)">Succ√®s</div>
                </div>
            </div>
        `;
        
        document.getElementById('recovery-code').textContent = p.recoveryCode;
    }

    copyRecoveryCode() {
        navigator.clipboard.writeText(this.currentProfile.recoveryCode);
        alert('Code copi√© !');
    }

    confirmDeleteProfile() {
        const p = this.currentProfile;
        
        document.getElementById('confirm-title').textContent = '‚ö†Ô∏è Supprimer le profil';
        document.getElementById('confirm-message').textContent = 
            `Supprimer le profil "${p.name}" ? Cette action est irr√©versible.`;
        
        const pinInput = document.getElementById('confirm-pin-input');
        pinInput.style.display = p.protected ? 'block' : 'none';
        document.getElementById('confirm-pin-error').style.display = 'none';
        
        if (p.protected) {
            this.clearPinInputs('confirm-pin');
        }
        
        this.pendingAction = 'delete';
        document.getElementById('confirm-action-btn').onclick = () => this.executeConfirmAction();
        
        this.showModal('modal-confirm');
    }

    checkConfirmPin() {
        const pin = this.getPin('confirm-pin');
        if (pin.length === 4) {
            if (pin === this.currentProfile.pin) {
                this.executeConfirmAction();
            } else {
                document.getElementById('confirm-pin-error').style.display = 'block';
                this.clearPinInputs('confirm-pin');
            }
        }
    }

    async executeConfirmAction() {
        const p = this.currentProfile;
        
        if (p.protected) {
            const pin = this.getPin('confirm-pin');
            if (pin !== p.pin) {
                document.getElementById('confirm-pin-error').style.display = 'block';
                return;
            }
        }
        
        if (this.pendingAction === 'delete') {
            await this.db.deleteProfile(p.id);
            this.profiles = this.profiles.filter(pr => pr.id !== p.id);
            this.currentProfile = null;
            this.closeModal('modal-confirm');
            this.showScreen('profile-select');
        }
    }

    renderSettings() {
        // Re-render settings with current states
        const screen = document.getElementById('screen-settings');
        const toggles = screen.querySelectorAll('.toggle');
        toggles.forEach(toggle => {
            const setting = toggle.getAttribute('onclick').match(/'(\w+)'/)[1];
            toggle.classList.toggle('active', this.settings[setting]);
        });
    }

    toggleSetting(key) {
        this.settings[key] = !this.settings[key];
        
        if (key === 'soundEnabled') {
            this.audio.enabled = this.settings.soundEnabled;
        }
        
        this.applySettings();
        this.saveSettings();
        this.renderSettings();
    }

    showModal(id) {
        document.getElementById(id).classList.add('active');
    }

    closeModal(id) {
        document.getElementById(id).classList.remove('active');
    }

    async saveCurrentProfile() {
        if (this.currentProfile) {
            await this.db.saveProfile(this.currentProfile);
        }
    }

    showTutorial() {
        const steps = [
            { icon: 'üëÜ', text: 'Glisse les bonbons pour les √©changer' },
            { icon: 'üç¨üç¨üç¨', text: 'Aligne 3 bonbons identiques pour les faire dispara√Ætre' },
            { icon: 'üî•', text: 'Encha√Æne les combos pour plus de points !' },
            { icon: '‚≠ê', text: 'Atteins l\'objectif avant d\'√©puiser tes coups' }
        ];
        
        this.tutorialStep = 0;
        this.tutorialSteps = steps;
        this.updateTutorial();
        document.getElementById('tutorial').style.display = 'flex';
    }

    updateTutorial() {
        const step = this.tutorialSteps[this.tutorialStep];
        document.getElementById('tutorial-icon').textContent = step.icon;
        document.getElementById('tutorial-text').textContent = step.text;
        
        let dots = '';
        for (let i = 0; i < this.tutorialSteps.length; i++) {
            dots += `<div class="tutorial-dot ${i === this.tutorialStep ? 'active' : ''}"></div>`;
        }
        document.getElementById('tutorial-dots').innerHTML = dots;
    }

    nextTutorialStep() {
        this.tutorialStep++;
        if (this.tutorialStep >= this.tutorialSteps.length) {
            document.getElementById('tutorial').style.display = 'none';
            this.currentProfile.tutorialDone = true;
            this.saveCurrentProfile();
        } else {
            this.updateTutorial();
        }
    }
}

// Initialize app
const app = new App();
document.addEventListener('DOMContentLoaded', () => app.init());

// Prevent zoom on double tap
let lastTouchEnd = 0;
document.addEventListener('touchend', (e) => {
    const now = Date.now();
    if (now - lastTouchEnd <= 300) {
        e.preventDefault();
    }
    lastTouchEnd = now;
}, false);

// Service Worker registration for PWA
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('data:application/javascript,' + encodeURIComponent(`
        self.addEventListener('install', (e) => self.skipWaiting());
        self.addEventListener('fetch', (e) => e.respondWith(fetch(e.request)));
    `)).catch(() => {});
}
    </script>
</body>
</html>